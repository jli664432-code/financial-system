{% extends "base.html" %}
{% block title %}交易列表 - 财务记账系统{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="mb-0">最近交易</h2>
        <p class="text-muted mb-0">以下展示最近 {{ transactions|length }} 条交易记录，包含分录详情。</p>
    </div>
</div>

{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ success_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% for tx in transactions %}
    <section class="card mb-3 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h5 mb-1">
                        凭证号：{{ tx.num or "（未填写）" }}
                        <span class="badge bg-primary ms-2">{{ tx.post_date }}</span>
                    </h3>
                    <p class="mb-1">摘要：{{ tx.description or "（无）" }}</p>
                    <p class="text-muted small mb-2">交易 ID：{{ tx.guid }}</p>
                </div>
                <div class="btn-group">
                    <a href="/transactions/{{ tx.guid }}/edit" class="btn btn-sm btn-outline-primary">编辑</a>
                    <form method="post" action="/transactions/{{ tx.guid }}/delete" onsubmit="return confirm('确定要删除该交易吗？删除后无法恢复。');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
                    </form>
                </div>
            </div>
            <div class="table-responsive mt-3">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>科目</th>
                            <th>金额（借为正，贷为负）</th>
                            <th>备注</th>
                            <th>对账状态</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for split in tx.splits %}
                        <tr>
                            <td>{{ split.account.name }} <span class="badge bg-secondary">{{ split.account.code or "无编码" }}</span></td>
                            <td>{{ "%.2f"|format(split.amount|float) }}</td>
                            <td>{{ split.memo or "-" }}</td>
                            <td>{{ split.reconcile_state }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
{% else %}
    <p>暂无交易记录。</p>
{% endfor %}
{% endblock %}
