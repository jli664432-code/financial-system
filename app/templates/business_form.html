{% extends "base.html" %}
{% block title %}{{ doc_type_name }} - 财务记账系统{% endblock %}

{% block content %}
<div class="main-card">
    <div class="card-body">
        <div style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 0.5rem;">{{ doc_type_name }}</h2>
            <p style="color: #64748b; font-size: 1rem; margin: 0;">{{ doc_type_desc }}</p>
        </div>

        {% if error %}
        <div class="alert alert-danger" style="padding: 14px 18px; background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 10px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
            <i class="ri-error-warning-line" style="font-size: 20px;"></i>
            <span><strong>提交失败：</strong>{{ error }}</span>
        </div>
        {% endif %}

        {% if success %}
        <div class="alert alert-success" style="padding: 14px 18px; background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; border-radius: 10px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
            <i class="ri-checkbox-circle-line" style="font-size: 20px;"></i>
            <span><strong>业务单据创建成功！</strong> <a href="/business/list" style="color: #15803d; text-decoration: underline;">查看业务单据列表</a> 或 <a href="/transactions/view" style="color: #15803d; text-decoration: underline;">查看交易列表</a></span>
        </div>
        {% endif %}

        <form method="post" id="businessForm" action="{{ request.url }}" style="background: #ffffff; padding: 0;">
            <!-- 基本信息区域 -->
            <div class="form-section" style="background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">
                    <i class="ri-file-text-line" style="margin-right: 8px; color: var(--primary);"></i>基本信息
                </h3>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="doc_no" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                            单据编号
                            <span style="color: #94a3b8; font-weight: 400; font-size: 0.875rem;">（可选）</span>
                        </label>
                        <input type="text" class="form-control" id="doc_no" name="doc_no" placeholder="例如：XS-20251118-001" style="background: white; border: 2px solid #e2e8f0;">
                    </div>
                    <div class="col-md-6">
                        <label for="doc_date" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                            业务日期 <span style="color: #dc2626;">*</span>
                        </label>
                        <input type="date" class="form-control" id="doc_date" name="doc_date" value="{{ today }}" required style="background: white; border: 2px solid #e2e8f0;">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="partner_name" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                            往来单位/员工
                        </label>
                        <input type="text" class="form-control" id="partner_name" name="partner_name" placeholder="客户/供应商/员工姓名" style="background: white; border: 2px solid #e2e8f0;">
                    </div>
                    <div class="col-md-6">
                        <label for="reference_no" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                            外部参考号
                        </label>
                        <input type="text" class="form-control" id="reference_no" name="reference_no" placeholder="例如：订单号、合同号" style="background: white; border: 2px solid #e2e8f0;">
                    </div>
                </div>

                <div class="mb-0">
                    <label for="description" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                        摘要说明
                    </label>
                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="简要描述本次业务" style="background: white; border: 2px solid #e2e8f0; resize: vertical;"></textarea>
                </div>
            </div>

            {% if show_cashflow %}
            <div class="form-section" style="background: #fff7ed; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #fed7aa;">
                <label for="cashflow_type_id" class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 12px; display: block;">
                    <i class="ri-money-dollar-circle-line" style="margin-right: 6px; color: #f59e0b;"></i>
                    现金流量分类（默认）<span style="color: #dc2626;">*</span>
                </label>
                <select class="form-select" id="cashflow_type_id" name="cashflow_type_id" required style="background: white; border: 2px solid #f59e0b; margin-bottom: 12px;">
                    <option value="">请选择（收付款业务必须选择）</option>
                    {% for cf_type in cashflow_types %}
                    <option value="{{ cf_type.id }}">{{ cf_type.name }}</option>
                    {% endfor %}
                </select>
                <div style="padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                    <i class="ri-alert-line" style="color: #d97706; font-size: 18px;"></i>
                    <p style="margin: 0; color: #92400e; font-size: 0.875rem; font-weight: 500;">
                        收付款业务必须选择现金流量分类，否则现金流量表不会显示
                    </p>
                </div>
            </div>
            {% else %}
            <div id="cashflowWarning" style="display: none; padding: 16px; background: #fef3c7; border-left: 4px solid #f59e0b; margin-bottom: 24px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                <i class="ri-information-line" style="color: #d97706; font-size: 20px;"></i>
                <p style="margin: 0; color: #92400e; font-size: 0.875rem; font-weight: 500;">
                    <strong>提示：</strong>检测到您选择了现金/银行类科目，建议选择现金流量分类以确保现金流量表正确显示。
                </p>
            </div>
            {% endif %}

            <!-- 业务明细区域 -->
            <div class="form-section" style="background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
                <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 8px;">
                        <i class="ri-list-check" style="margin-right: 8px; color: var(--primary);"></i>业务明细
                    </h3>
                    <p style="margin: 0; color: #64748b; font-size: 0.875rem;">每条明细描述一对借贷科目与金额</p>
                </div>

                <div id="itemsContainer">
                    <div class="split-box item-row" data-item-index="0" style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e2e8f0; margin-bottom: 16px; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                            <h4 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--primary);">
                                <i class="ri-file-list-3-line" style="margin-right: 6px;"></i>明细 1
                            </h4>
                            <button type="button" class="btn btn-danger remove-item" style="display: none; padding: 6px 14px; font-size: 0.875rem;">
                                <i class="ri-delete-bin-line"></i> 删除
                            </button>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label class="form-label" style="font-weight: 600; color: #334155; margin: 0;">
                                        借方科目 <span style="color: #dc2626;">*</span>
                                    </label>
                                    <button type="button" class="btn btn-success btn-sm" style="padding: 4px 10px; font-size: 0.75rem;" 
                                            onclick="showQuickAddAccount('debit', 0)">
                                        <i class="ri-add-line"></i> 快速添加
                                    </button>
                                </div>
                                <select class="form-select debit-account" name="items_0_debit_account_guid" id="items_0_debit_account_guid" required style="background: white; border: 2px solid #e2e8f0;">
                                    <option value="">请选择科目</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.guid }}">{{ account.code or "" }} {{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label class="form-label" style="font-weight: 600; color: #334155; margin: 0;">
                                        贷方科目 <span style="color: #dc2626;">*</span>
                                    </label>
                                    <button type="button" class="btn btn-success btn-sm" style="padding: 4px 10px; font-size: 0.75rem;" 
                                            onclick="showQuickAddAccount('credit', 0)">
                                        <i class="ri-add-line"></i> 快速添加
                                    </button>
                                </div>
                                <select class="form-select credit-account" name="items_0_credit_account_guid" id="items_0_credit_account_guid" required style="background: white; border: 2px solid #e2e8f0;">
                                    <option value="">请选择科目</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.guid }}">{{ account.code or "" }} {{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                                    金额（元） <span style="color: #dc2626;">*</span>
                                </label>
                                <input type="number" step="0.01" class="form-control" name="items_0_amount" required style="background: white; border: 2px solid #e2e8f0;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                                    明细描述
                                </label>
                                <input type="text" class="form-control" name="items_0_description" placeholder="例如：销售收入" style="background: white; border: 2px solid #e2e8f0;">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                                    备注
                                </label>
                                <input type="text" class="form-control" name="items_0_memo" placeholder="可留空" style="background: white; border: 2px solid #e2e8f0;">
                            </div>
                            {% if show_cashflow %}
                            <div class="col-md-6">
                                <label class="form-label" style="font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">
                                    现金流量分类（行级）
                                </label>
                                <select class="form-select" name="items_0_cashflow_type_id" style="background: white; border: 2px solid #e2e8f0;">
                                    <option value="">使用单据默认值</option>
                                    {% for cf_type in cashflow_types %}
                                    <option value="{{ cf_type.id }}">{{ cf_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" id="addItemBtn" style="width: 100%; margin-top: 8px;">
                    <i class="ri-add-line"></i> 添加明细
                </button>
            </div>

            <!-- 提交按钮区域 -->
            <div style="display: flex; gap: 12px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px 24px; font-size: 1rem;">
                    <i class="ri-check-line"></i> 提交业务单据
                </button>
                <a href="/business/list" class="btn btn-secondary" style="padding: 12px 24px; font-size: 1rem;">
                    <i class="ri-arrow-left-line"></i> 返回列表
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    .form-section {
        transition: all 0.3s ease;
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .item-row:hover {
        border-color: var(--primary) !important;
        box-shadow: 0 4px 12px rgba(67,97,238,0.15) !important;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 4px rgba(67,97,238,0.1) !important;
    }
    label {
        font-size: 0.9375rem;
    }
</style>

<!-- 快速添加科目模态框 -->
<div class="modal fade" id="quickAddAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">快速添加科目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickAddAccountForm">
                <div class="modal-body">
                    <input type="hidden" id="quickAddTarget" value="">
                    <input type="hidden" id="quickAddItemIndex" value="">
                    
                    <div class="mb-3">
                        <label for="quickAccountName" class="form-label">科目名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quickAccountName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickAccountType" class="form-label">科目类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="quickAccountType" required>
                            <option value="">请选择</option>
                            <option value="ASSET">资产</option>
                            <option value="CURRENT_ASSET">流动资产</option>
                            <option value="FIXED_ASSET">固定资产</option>
                            <option value="LIABILITY">负债</option>
                            <option value="CURRENT_LIABILITY">流动负债</option>
                            <option value="EQUITY">所有者权益</option>
                            <option value="INCOME">收入</option>
                            <option value="REVENUE">营业收入</option>
                            <option value="EXPENSE">费用</option>
                            <option value="COST">成本</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickAccountCode" class="form-label">科目编码（可选）</label>
                        <input type="text" class="form-control" id="quickAccountCode">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="quickIsCash">
                        <label class="form-check-label" for="quickIsCash">现金/银行类科目</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加并选择</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let itemIndex = 1;

document.getElementById('addItemBtn').addEventListener('click', function() {
    const container = document.getElementById('itemsContainer');
    const firstItem = container.querySelector('.item-row');
    const newItem = firstItem.cloneNode(true);
    
    // 更新索引
    const currentIndex = itemIndex;
    newItem.setAttribute('data-item-index', currentIndex);
    const h4 = newItem.querySelector('h4');
    if (h4) {
        const icon = h4.querySelector('i');
        h4.innerHTML = icon ? `<i class="ri-file-list-3-line" style="margin-right: 6px;"></i>明细 ${currentIndex + 1}` : `明细 ${currentIndex + 1}`;
    }
    
    // 更新所有输入框的 name 和 id 属性
    newItem.querySelectorAll('input, select').forEach(input => {
        if (input.name) {
            input.name = input.name.replace(/items_\d+_/, `items_${currentIndex}_`);
            input.id = input.id.replace(/items_\d+_/, `items_${currentIndex}_`);
            input.value = '';
        }
    });
    
    // 更新快速添加按钮的 onclick
    newItem.querySelectorAll('button[onclick*="showQuickAddAccount"]').forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (onclick) {
            const match = onclick.match(/showQuickAddAccount\('(\w+)',\s*(\d+)\)/);
            if (match) {
                btn.setAttribute('onclick', `showQuickAddAccount('${match[1]}', ${currentIndex})`);
            }
        }
    });
    
    // 显示删除按钮
    newItem.querySelector('.remove-item').style.display = 'block';
    
    container.appendChild(newItem);
    itemIndex++;
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-item')) {
        const itemRow = e.target.closest('.item-row');
        if (document.querySelectorAll('.item-row').length > 1) {
            itemRow.remove();
        } else {
            alert('至少需要一条明细');
        }
    }
});

// 快速添加科目
function showQuickAddAccount(target, itemIndex) {
    document.getElementById('quickAddTarget').value = target;
    document.getElementById('quickAddItemIndex').value = itemIndex;
    const modal = new bootstrap.Modal(document.getElementById('quickAddAccountModal'));
    modal.show();
}

document.getElementById('quickAddAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const name = document.getElementById('quickAccountName').value;
    const accountType = document.getElementById('quickAccountType').value;
    const code = document.getElementById('quickAccountCode').value;
    const isCash = document.getElementById('quickIsCash').checked;
    const target = document.getElementById('quickAddTarget').value;
    const itemIndex = document.getElementById('quickAddItemIndex').value;
    
    if (!name || !accountType) {
        alert('请填写科目名称和类型');
        return;
    }
    
    try {
        const response = await fetch('/api/accounts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                account_type: accountType,
                code: code || null,
                is_cash: isCash,
            }),
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '添加失败');
        }
        
        const newAccount = await response.json();
        
        // 添加到下拉框
        const selectId = `items_${itemIndex}_${target}_account_guid`;
        const select = document.getElementById(selectId);
        if (select) {
            const option = document.createElement('option');
            option.value = newAccount.guid;
            option.textContent = (newAccount.code ? newAccount.code + ' ' : '') + newAccount.name;
            option.selected = true;
            select.appendChild(option);
            
            // 如果新科目是现金类，触发检查
            if (newAccount.is_cash) {
                checkCashAccount(selectId);
            }
        }
        
        // 关闭模态框并重置表单
        bootstrap.Modal.getInstance(document.getElementById('quickAddAccountModal')).hide();
        document.getElementById('quickAddAccountForm').reset();
        
        alert('科目添加成功！已自动选择该科目。');
    } catch (error) {
        alert('添加失败：' + error.message);
    }
});

// 检查是否选择了现金类科目
async function checkCashAccount(selectId) {
    const select = document.getElementById(selectId);
    if (!select || !select.value) return;
    
    try {
        const response = await fetch(`/api/accounts/${select.value}`);
        if (response.ok) {
            const account = await response.json();
            if (account.is_cash) {
                // 显示提示
                const warning = document.getElementById('cashflowWarning');
                if (warning) {
                    warning.style.display = 'block';
                }
                
                // 如果表单中有现金流量分类选择框，提示选择
                const cfSelect = document.getElementById('cashflow_type_id');
                if (cfSelect && !cfSelect.value) {
                    cfSelect.style.borderColor = '#dc2626';
                    cfSelect.addEventListener('change', function() {
                        if (this.value) {
                            this.style.borderColor = '';
                        }
                    });
                }
            }
        }
    } catch (error) {
        console.error('检查科目失败:', error);
    }
}

// 监听科目选择变化
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('debit-account') || e.target.classList.contains('credit-account')) {
        checkCashAccount(e.target.id);
    }
});
</script>
{% endblock %}

