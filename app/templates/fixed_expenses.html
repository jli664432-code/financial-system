{% extends "base.html" %}
{% block title %}å›ºå®šè´¹ç”¨ç®¡ç† - è´¢åŠ¡è®°è´¦ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ğŸ’¸ å›ºå®šè´¹ç”¨ç®¡ç†</h2>
    <form method="post" action="/fixed-expenses/run">
        <input type="hidden" name="action" value="all">
        <button type="submit" class="btn btn-primary">æ‰§è¡Œæœ¬æœˆåˆ°æœŸæ‰£è´¹</button>
    </form>
 </div>

{% if success %}
<div class="alert alert-success" role="alert">{{ success }}</div>
{% endif %}
{% if error %}
<div class="alert alert-danger" role="alert">{{ error }}</div>
{% endif %}
{% if warning %}
<div class="alert alert-warning" role="alert">{{ warning }}</div>
{% endif %}

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h4 class="card-title mb-3">{{ "ç¼–è¾‘å›ºå®šè´¹ç”¨" if editing_expense else "æ–°å¢å›ºå®šè´¹ç”¨" }}</h4>
                <form method="post" action="/fixed-expenses/manage">
                    <input type="hidden" name="action" value="{{ 'update' if editing_expense else 'create' }}">
                    {% if editing_expense %}
                    <input type="hidden" name="expense_id" value="{{ editing_expense.id }}">
                    {% endif %}

                    <div class="mb-3">
                        <label for="name" class="form-label">è´¹ç”¨åç§°</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="å¦‚ï¼šå·¥èµ„ã€æˆ¿ç§Ÿ"
                               value="{{ editing_expense.name if editing_expense else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="amount" class="form-label">æ‰£æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount"
                               value="{{ editing_expense.amount if editing_expense else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="expense_account_guid" class="form-label">è´¹ç”¨ç§‘ç›®ï¼ˆå€Ÿæ–¹ï¼‰</label>
                        <select class="form-select" id="expense_account_guid" name="expense_account_guid" required>
                            <option value="" disabled {{ '' if editing_expense else 'selected' }}>è¯·é€‰æ‹©è´¹ç”¨ç§‘ç›®</option>
                            {% for account in accounts %}
                            <option value="{{ account.guid }}"
                                    {% if editing_expense and account.guid == editing_expense.expense_account_guid %}selected{% endif %}>
                                {{ account.code or '-' }} {{ account.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="primary_account_guid" class="form-label">ä¼˜å…ˆæ‰£æ¬¾ç§‘ç›®ï¼ˆåº“å­˜ç°é‡‘ï¼‰</label>
                        <select class="form-select" id="primary_account_guid" name="primary_account_guid" required>
                            <option value="" disabled {{ '' if editing_expense else 'selected' }}>è¯·é€‰æ‹©ä¼˜å…ˆç§‘ç›®</option>
                            {% for account in accounts %}
                            <option value="{{ account.guid }}"
                                    {% if editing_expense and account.guid == editing_expense.primary_account_guid %}selected{% endif %}>
                                {{ account.code or '-' }} {{ account.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="fallback_account_guid" class="form-label">å¤‡ç”¨æ‰£æ¬¾ç§‘ç›®ï¼ˆé“¶è¡Œå­˜æ¬¾ï¼‰</label>
                        <select class="form-select" id="fallback_account_guid" name="fallback_account_guid">
                            <option value="">ä¸è®¾ç½®</option>
                            {% for account in accounts %}
                            <option value="{{ account.guid }}"
                                    {% if editing_expense and account.guid == editing_expense.fallback_account_guid %}selected{% endif %}>
                                {{ account.code or '-' }} {{ account.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">å½“åº“å­˜ç°é‡‘ä¸è¶³æ—¶ï¼Œè‡ªåŠ¨æ”¹ç”¨å¤‡ç”¨ç§‘ç›®æ‰£æ¬¾å¹¶å‘é€æé†’ã€‚</div>
                    </div>

                    <div class="mb-3">
                        <label for="day_of_month" class="form-label">æ‰£æ¬¾æ—¥ï¼ˆ1-28ï¼‰</label>
                        <input type="number" class="form-control" id="day_of_month" name="day_of_month"
                               min="1" max="28"
                               value="{{ editing_expense.day_of_month if editing_expense else 5 }}" required>
                        <div class="form-text">ç³»ç»Ÿä¼šåœ¨è¯¥æ—¥æœŸï¼ˆæˆ–ä¹‹åï¼‰æ‰§è¡Œæœ¬æœˆæ‰£è´¹ã€‚</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active"
                               {% if editing_expense is none or editing_expense.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">å¯ç”¨è¯¥å›ºå®šè´¹ç”¨</label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            {{ "ä¿å­˜ä¿®æ”¹" if editing_expense else "æ–°å¢å›ºå®šè´¹ç”¨" }}
                        </button>
                        {% if editing_expense %}
                        <a href="/fixed-expenses" class="btn btn-outline-secondary">å–æ¶ˆç¼–è¾‘</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-3">å½“å‰é…ç½®</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>è´¹ç”¨åç§°</th>
                                <th style="width: 100px;">é‡‘é¢</th>
                                <th>è´¹ç”¨ç§‘ç›®</th>
                                <th>ä¼˜å…ˆæ‰£æ¬¾</th>
                                <th>å¤‡ç”¨ç§‘ç›®</th>
                                <th style="width: 80px;">æ‰£æ¬¾æ—¥</th>
                                <th style="width: 120px;">çŠ¶æ€</th>
                                <th style="width: 130px;">æœ€è¿‘æ‰§è¡Œ</th>
                                <th style="width: 220px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in fixed_expense_rows %}
                            {% set expense = row.expense %}
                            <tr>
                                <td>{{ expense.name }}</td>
                                <td>{{ "%.2f"|format(expense.amount|float) }}</td>
                                <td>{{ expense.expense_account.name if expense.expense_account else "-" }}</td>
                                <td>{{ expense.primary_account.name if expense.primary_account else "-" }}</td>
                                <td>{{ expense.fallback_account.name if expense.fallback_account else "-" }}</td>
                                <td>{{ expense.day_of_month }}</td>
                                <td>
                                    {% if expense.is_active %}
                                        <span class="badge bg-success">å¯ç”¨</span>
                                    {% else %}
                                        <span class="badge bg-secondary">åœç”¨</span>
                                    {% endif %}
                                    <div>
                                        {% if row.is_due %}
                                            <small class="text-success">æœ¬æœˆå·²åˆ°æœŸ</small>
                                        {% else %}
                                            <small class="text-muted">é¢„è®¡ {{ row.due_date }} æ‰§è¡Œ</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if expense.last_run_month %}
                                        {{ expense.last_run_month }}<br>
                                        <small class="text-muted">{{ expense.last_run_at }}</small>
                                    {% else %}
                                        <span class="text-muted">æœªæ‰§è¡Œ</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a href="/fixed-expenses?edit_id={{ expense.id }}" class="btn btn-outline-secondary btn-sm">ç¼–è¾‘</a>
                                        <form method="post" action="/fixed-expenses/manage" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥å›ºå®šè´¹ç”¨ï¼Ÿ');">
                                            <input type="hidden" name="action" value="delete">
                                            <input type="hidden" name="expense_id" value="{{ expense.id }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">åˆ é™¤</button>
                                        </form>
                                        <form method="post" action="/fixed-expenses/run">
                                            <input type="hidden" name="action" value="single">
                                            <input type="hidden" name="expense_id" value="{{ expense.id }}">
                                            <button type="submit" class="btn btn-outline-primary btn-sm" {% if not expense.is_active %}disabled{% endif %}>
                                                æ‰§è¡Œæœ¬æœˆ
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">å°šæœªé…ç½®å›ºå®šè´¹ç”¨</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


