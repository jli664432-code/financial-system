{% extends "base.html" %}
{% block title %}ä¼šè®¡ç§‘ç›®ç®¡ç† - è´¢åŠ¡è®°è´¦ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“‘ ä¼šè®¡ç§‘ç›®ç®¡ç†</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            â• æ·»åŠ ç§‘ç›®
        </button>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>é”™è¯¯ï¼š</strong>{{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>æˆåŠŸï¼š</strong>{{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ç§‘ç›®åç§°</th>
                            <th>ç¼–ç </th>
                            <th>ç±»å‹</th>
                            <th>æ˜¯å¦ç°é‡‘/é“¶è¡Œ</th>
                            <th>ä½™é¢</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr>
                            <td>
                                <strong>{{ account.name }}</strong>
                                {% if account.hidden %}
                                <span class="badge bg-secondary">éšè—</span>
                                {% endif %}
                                {% if account.placeholder %}
                                <span class="badge bg-info">åˆ†ç±»</span>
                                {% endif %}
                            </td>
                            <td>{{ account.code or "-" }}</td>
                            <td>{{ account.account_type }}</td>
                            <td>
                                {% if account.is_cash %}
                                <span class="badge bg-success">æ˜¯</span>
                                {% else %}
                                <span class="text-muted">å¦</span>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ "%.2f"|format(account.current_balance|float) }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="editAccount('{{ account.guid }}', '{{ account.name }}', '{{ account.account_type }}', '{{ account.code or "" }}', '{{ account.description or "" }}', {{ account.hidden|lower }}, {{ account.placeholder|lower }}, {{ account.is_cash|lower }}, '{{ account.parent_guid or "" }}')">
                                    ç¼–è¾‘
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteAccount('{{ account.guid }}', '{{ account.name }}')">
                                    åˆ é™¤
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">æš‚æ— ç§‘ç›®æ•°æ®</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- æ·»åŠ /ç¼–è¾‘ç§‘ç›®æ¨¡æ€æ¡† -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ·»åŠ ç§‘ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="accountForm" method="post" action="/accounts/manage">
                <div class="modal-body">
                    <input type="hidden" id="accountGuid" name="account_guid" value="">
                    <input type="hidden" id="formAction" name="action" value="create">
                    
                    <div class="mb-3">
                        <label for="accountName" class="form-label">ç§‘ç›®åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="accountName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountType" class="form-label">ç§‘ç›®ç±»å‹ <span class="text-danger">*</span></label>
                        <select class="form-select" id="accountType" name="account_type" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ASSET">èµ„äº§</option>
                            <option value="CURRENT_ASSET">æµåŠ¨èµ„äº§</option>
                            <option value="FIXED_ASSET">å›ºå®šèµ„äº§</option>
                            <option value="LIABILITY">è´Ÿå€º</option>
                            <option value="CURRENT_LIABILITY">æµåŠ¨è´Ÿå€º</option>
                            <option value="EQUITY">æ‰€æœ‰è€…æƒç›Š</option>
                            <option value="INCOME">æ”¶å…¥</option>
                            <option value="REVENUE">è¥ä¸šæ”¶å…¥</option>
                            <option value="EXPENSE">è´¹ç”¨</option>
                            <option value="COST">æˆæœ¬</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountCode" class="form-label">ç§‘ç›®ç¼–ç </label>
                        <input type="text" class="form-control" id="accountCode" name="code">
                    </div>
                    
                    <div class="mb-3">
                        <label for="parentGuid" class="form-label">çˆ¶çº§ç§‘ç›®</label>
                        <select class="form-select" id="parentGuid" name="parent_guid">
                            <option value="">æ— ï¼ˆé¡¶çº§ç§‘ç›®ï¼‰</option>
                            {% for account in accounts %}
                            <option value="{{ account.guid }}">{{ account.code or "" }} {{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountDescription" class="form-label">è¯´æ˜</label>
                        <textarea class="form-control" id="accountDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isHidden" name="hidden" value="true">
                                <label class="form-check-label" for="isHidden">éšè—</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPlaceholder" name="placeholder" value="true">
                                <label class="form-check-label" for="isPlaceholder">ä»…ä½œåˆ†ç±»</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isCash" name="is_cash" value="true">
                                <label class="form-check-label" for="isCash">ç°é‡‘/é“¶è¡Œ</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤ç§‘ç›® <strong id="deleteAccountName"></strong> å—ï¼Ÿ</p>
                <p class="text-danger small">æ³¨æ„ï¼šå¦‚æœç§‘ç›®æœ‰å­ç§‘ç›®ã€ä½™é¢ä¸ä¸º0æˆ–å·²è¢«ä½¿ç”¨ï¼Œå°†æ— æ³•åˆ é™¤ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <form id="deleteForm" method="post" action="/accounts/manage" style="display: inline;">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" id="deleteAccountGuid" name="account_guid" value="">
                    <button type="submit" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function editAccount(guid, name, accountType, code, description, hidden, placeholder, isCash, parentGuid) {
    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç§‘ç›®';
    document.getElementById('formAction').value = 'update';
    document.getElementById('accountGuid').value = guid;
    document.getElementById('accountName').value = name;
    document.getElementById('accountType').value = accountType;
    document.getElementById('accountCode').value = code || '';
    document.getElementById('accountDescription').value = description || '';
    document.getElementById('isHidden').checked = hidden;
    document.getElementById('isPlaceholder').checked = placeholder;
    document.getElementById('isCash').checked = isCash;
    document.getElementById('parentGuid').value = parentGuid || '';
    
    const modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
    modal.show();
}

function deleteAccount(guid, name) {
    document.getElementById('deleteAccountName').textContent = name;
    document.getElementById('deleteAccountGuid').value = guid;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// é‡ç½®è¡¨å•
document.getElementById('addAccountModal').addEventListener('hidden.bs.modal', function () {
    if (document.getElementById('formAction').value === 'create') {
        document.getElementById('accountForm').reset();
        document.getElementById('formAction').value = 'create';
        document.getElementById('accountGuid').value = '';
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç§‘ç›®';
    }
});
</script>
{% endblock %}
