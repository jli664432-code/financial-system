{% extends "base.html" %}
{% block title %}编辑交易 - 财务记账系统{% endblock %}
{% block content %}
<h2>编辑交易</h2>
{% if error %}
<div class="alert alert-danger" role="alert">
    提交失败：{{ error }}
</div>
{% endif %}
<form method="post" action="{{ form_action }}">
    <div class="two-columns">
        <div>
            <label for="post_date">记账日期</label>
            <input type="date" id="post_date" name="post_date" value="{{ post_date_value }}" required />
        </div>
        <div>
            <label for="num">凭证号（可选）</label>
            <input type="text" id="num" name="num" value="{{ num_value }}" placeholder="例如：JZ20251111" />
        </div>
    </div>
    <label for="description">摘要</label>
    <textarea id="description" name="description" rows="2" placeholder="简要描述本次交易">{{ description_value }}</textarea>

    <div id="splitsContainer" data-accounts='{{ accounts_json | tojson | safe }}'>
        {% for split in splits_data %}
        <div class="split-box split-row" data-index="{{ loop.index0 }}">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">分录 {{ loop.index }}</h3>
                <button type="button" class="btn remove-split" style="display: none; background: #dc2626; padding: 4px 12px; font-size: 12px;">删除</button>
            </div>
            <div class="two-columns">
                <div>
                    <label>借/贷方向</label>
                    <select name="splits_{{ loop.index0 }}_direction" required>
                        <option value="debit" {% if split.direction == "debit" %}selected{% endif %}>借方</option>
                        <option value="credit" {% if split.direction == "credit" %}selected{% endif %}>贷方</option>
                    </select>
                </div>
                <div>
                    <label>金额（元）</label>
                    <input type="number" step="0.01" name="splits_{{ loop.index0 }}_amount" value="{{ split.amount }}" required />
                </div>
            </div>
            <label>科目</label>
            <select name="splits_{{ loop.index0 }}_account_guid" required>
                <option value="">请选择科目</option>
                {% for account in accounts %}
                <option value="{{ account.guid }}" {% if account.guid == split.account_guid %}selected{% endif %}>
                    {{ account.code or "" }} {{ account.name }}
                </option>
                {% endfor %}
            </select>
            <label>备注</label>
            <input type="text" name="splits_{{ loop.index0 }}_memo" value="{{ split.memo }}" placeholder="可留空" />
        </div>
        {% endfor %}
    </div>

    <button type="button" class="btn" style="background: #6b7280; margin-bottom: 16px;" id="addSplitBtn">➕ 添加分录</button>

    <div>
        <button class="btn" type="submit">保存修改</button>
        <a href="/transactions/view" class="btn" style="background: #6b7280; margin-left: 8px;">取消</a>
    </div>
</form>
<p style="margin-top: 16px; color: #64748b;">
    * 借方金额输入正数，贷方金额输入正数并选择“贷方”，系统会自动转换为负值；请确保所有分录金额总和为 0。
</p>

<script src="/static/js/transaction_form.js" defer></script>
{% endblock %}
