{% extends "base.html" %}
{% block title %}ä¼šè®¡æŠ¥è¡¨ - è´¢åŠ¡è®°è´¦ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">ğŸ“ˆ ä¼šè®¡æŠ¥è¡¨</h2>
        {% if not is_current_report %}
        <a href="/reports/financial/current" class="btn btn-primary">
            âš¡ å¿«é€Ÿç”Ÿæˆå½“å‰æŠ¥è¡¨
        </a>
        {% else %}
        <a href="/reports/financial" class="btn btn-secondary">
            ğŸ“… æŸ¥çœ‹æœˆåº¦æŠ¥è¡¨
        </a>
        {% endif %}
    </div>
    
    <div class="alert alert-info" role="alert">
        {% if report_month_label %}
        å½“å‰å±•ç¤ºçš„æŠ¥è¡¨ï¼š<strong>{{ report_month_label }}</strong>
        {% if is_current_report %}
        ï¼ˆå®æ—¶ç”Ÿæˆï¼Œæœªä¿å­˜ï¼‰
        {% else %}
        ï¼ˆä¸Šä¸€æ•´æœˆï¼‰
        {% endif %}
        {% else %}
        æš‚æ— å¯ç”¨çš„æœˆåº¦æŠ¥è¡¨ã€‚
        {% endif %}
        {% if not is_current_report %}
        ç³»ç»Ÿä¼šåœ¨è·¨æœˆæ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆæœ€æ–°æŠ¥è¡¨ï¼Œå¹¶æ¸…é™¤æ—§æŠ¥è¡¨ç¼“å­˜ã€‚
        {% endif %}
    </div>
    
    {% if error %}
        <div class="alert alert-danger" role="alert">
            <strong>é”™è¯¯ï¼š</strong>{{ error }}
        </div>
    {% endif %}

    <!-- èµ„äº§è´Ÿå€ºè¡¨ -->
    {% if balance_sheet %}
    <div class="mb-5">
        <h3 class="mb-3">ğŸ“Š èµ„äº§è´Ÿå€ºè¡¨</h3>
        <p class="text-muted">æŠ¥è¡¨æ—¥æœŸï¼š{{ balance_sheet.report_date }}</p>
        
        <div class="row">
            <!-- èµ„äº§ -->
            <div class="col-md-6">
                <h4 class="mb-3">èµ„äº§</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">ç¼–ç </th>
                                <th style="width: 50%;">ç§‘ç›®åç§°</th>
                                <th style="width: 30%; text-align: right;">ä½™é¢</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in balance_sheet.assets %}
                            <tr {% if item.is_subtotal %}class="table-secondary"{% endif %}>
                                <td>{{ item.code or "-" }}</td>
                                <td>{{ item.name }}</td>
                                <td style="text-align: right;">{{ "%.2f"|format(item.balance|float) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">æš‚æ— èµ„äº§ç§‘ç›®</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-info">
                                <td colspan="2"><strong>èµ„äº§åˆè®¡</strong></td>
                                <td style="text-align: right;"><strong>{{ "%.2f"|format(balance_sheet.asset_total|float) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- è´Ÿå€ºå’Œæ‰€æœ‰è€…æƒç›Š -->
            <div class="col-md-6">
                <h4 class="mb-3">è´Ÿå€ºå’Œæ‰€æœ‰è€…æƒç›Š</h4>
                
                <!-- è´Ÿå€º -->
                <div class="mb-3">
                    <h5 class="mb-2">è´Ÿå€º</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">ç¼–ç </th>
                                    <th style="width: 50%;">ç§‘ç›®åç§°</th>
                                    <th style="width: 30%; text-align: right;">ä½™é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_sheet.liabilities %}
                                <tr {% if item.is_subtotal %}class="table-secondary"{% endif %}>
                                    <td>{{ item.code or "-" }}</td>
                                    <td>{{ item.name }}</td>
                                    <td style="text-align: right;">{{ "%.2f"|format((item.balance|float)|abs) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">æš‚æ— è´Ÿå€ºç§‘ç›®</td>
                                </tr>
                                {% endfor %}
                                <tr class="table-warning">
                                    <td colspan="2"><strong>è´Ÿå€ºåˆè®¡</strong></td>
                                    <td style="text-align: right;"><strong>{{ "%.2f"|format(balance_sheet.liability_total|float) }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ‰€æœ‰è€…æƒç›Š -->
                <div class="mb-3">
                    <h5 class="mb-2">æ‰€æœ‰è€…æƒç›Š</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">ç¼–ç </th>
                                    <th style="width: 50%;">ç§‘ç›®åç§°</th>
                                    <th style="width: 30%; text-align: right;">ä½™é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in balance_sheet.equity %}
                                <tr {% if item.is_subtotal %}class="table-secondary"{% endif %}>
                                    <td>{{ item.code or "-" }}</td>
                                    <td>{{ item.name }}</td>
                                    <td style="text-align: right;">{{ "%.2f"|format((item.balance|float)|abs) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">æš‚æ— æƒç›Šç§‘ç›®</td>
                                </tr>
                                {% endfor %}
                                <tr class="table-warning">
                                    <td colspan="2"><strong>æ‰€æœ‰è€…æƒç›Šåˆè®¡</strong></td>
                                    <td style="text-align: right;"><strong>{{ "%.2f"|format(balance_sheet.equity_total|float) }}</strong></td>
                                </tr>
                                {% if balance_sheet.net_income %}
                                <tr class="table-success">
                                    <td colspan="2"><strong>æœªåˆ†é…åˆ©æ¶¦ï¼ˆå‡€åˆ©æ¶¦ï¼‰</strong></td>
                                    <td style="text-align: right;"><strong>{{ "%.2f"|format(balance_sheet.net_income|float) }}</strong></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- è´Ÿå€ºå’Œæ‰€æœ‰è€…æƒç›Šåˆè®¡ -->
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <tbody>
                            <tr class="table-info">
                                <td colspan="2"><strong>è´Ÿå€ºå’Œæ‰€æœ‰è€…æƒç›Šåˆè®¡</strong></td>
                                <td style="text-align: right;"><strong>{{ "%.2f"|format(balance_sheet.total_liability_equity|float) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- å¹³è¡¡æ£€æŸ¥ -->
        <div class="mt-3">
            {% if balance_sheet.is_balanced %}
                <div class="alert alert-success" role="alert">
                    <strong>âœ“ å¹³è¡¡æ£€æŸ¥é€šè¿‡</strong>ï¼šèµ„äº§ = è´Ÿå€º + æ‰€æœ‰è€…æƒç›Š + å‡€åˆ©æ¶¦
                    <br>
                    <small>
                        èµ„äº§åˆè®¡ï¼š{{ "%.2f"|format(balance_sheet.asset_total|float) }} = 
                        è´Ÿå€ºåˆè®¡ï¼š{{ "%.2f"|format(balance_sheet.liability_total|float) }} + 
                        æ‰€æœ‰è€…æƒç›Šï¼š{{ "%.2f"|format(balance_sheet.equity_total|float) }} + 
                        å‡€åˆ©æ¶¦ï¼š{{ "%.2f"|format(balance_sheet.net_income|float) }}
                    </small>
                </div>
            {% else %}
                {% set diff = balance_sheet.asset_total|float - balance_sheet.total_liability_equity|float %}
                <div class="alert alert-warning" role="alert">
                    <strong>âš  å¹³è¡¡æ£€æŸ¥æœªé€šè¿‡</strong>ï¼šå·®é¢ = {{ "%.2f"|format(diff) }}
                    <br>
                    <small>
                        èµ„äº§åˆè®¡ï¼š{{ "%.2f"|format(balance_sheet.asset_total|float) }} â‰  
                        è´Ÿå€º + æ‰€æœ‰è€…æƒç›Š + å‡€åˆ©æ¶¦ï¼š{{ "%.2f"|format(balance_sheet.total_liability_equity|float) }}
                    </small>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- åˆ©æ¶¦è¡¨ -->
    {% if income_statement %}
    <div class="mb-5">
        <h3 class="mb-3">ğŸ’° åˆ©æ¶¦è¡¨</h3>
        <p class="text-muted">
            æœŸé—´ï¼š{{ income_statement.start_date }} è‡³ {{ income_statement.end_date }}
        </p>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th style="width: 20%;">ç¼–ç </th>
                        <th style="width: 50%;">ç§‘ç›®åç§°</th>
                        <th style="width: 30%; text-align: right;">é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- æ”¶å…¥ -->
                    <tr class="table-primary">
                        <td colspan="3"><strong>ä¸€ã€æ”¶å…¥</strong></td>
                    </tr>
                    {% for item in income_statement.revenues %}
                    <tr {% if item.is_subtotal %}class="table-secondary"{% endif %}>
                        <td>{{ item.code or "-" }}</td>
                        <td>{{ item.name }}</td>
                        <td style="text-align: right;">{{ "%.2f"|format((item.amount|float)|abs) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">æš‚æ— æ”¶å…¥ç§‘ç›®</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="2"><strong>æ”¶å…¥åˆè®¡</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(income_statement.revenue_total|float) }}</strong></td>
                    </tr>
                    
                    <!-- è´¹ç”¨ -->
                    <tr class="table-primary">
                        <td colspan="3"><strong>äºŒã€è´¹ç”¨</strong></td>
                    </tr>
                    {% for item in income_statement.expenses %}
                    <tr {% if item.is_subtotal %}class="table-secondary"{% endif %}>
                        <td>{{ item.code or "-" }}</td>
                        <td>{{ item.name }}</td>
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">æš‚æ— è´¹ç”¨ç§‘ç›®</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td colspan="2"><strong>è´¹ç”¨åˆè®¡</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(income_statement.expense_total|float) }}</strong></td>
                    </tr>
                    
                    <!-- å‡€åˆ©æ¶¦ -->
                    <tr class="table-success">
                        <td colspan="2"><strong>ä¸‰ã€å‡€åˆ©æ¶¦</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(income_statement.net_income|float) }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- ç°é‡‘æµé‡è¡¨ -->
    {% if cashflow_statement %}
    <div class="mb-5">
        <h3 class="mb-3">ğŸ’¸ ç°é‡‘æµé‡è¡¨</h3>
        <p class="text-muted">
            æœŸé—´ï¼š{{ cashflow_statement.start_date }} è‡³ {{ cashflow_statement.end_date }}
        </p>
        
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50%;">é¡¹ç›®</th>
                        <th style="width: 25%; text-align: right;">æµå…¥</th>
                        <th style="width: 25%; text-align: right;">æµå‡º</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ç»è¥æ´»åŠ¨ -->
                    <tr class="table-primary">
                        <td colspan="3"><strong>ä¸€ã€ç»è¥æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡</strong></td>
                    </tr>
                    {% for item in cashflow_statement.operating.item_list %}
                    <tr>
                        <td>{{ item.category_name }}</td>
                        {% if item.direction == "INFLOW" %}
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        <td style="text-align: right;">-</td>
                        {% else %}
                        <td style="text-align: right;">-</td>
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">æš‚æ— ç»è¥æ´»åŠ¨ç°é‡‘æµé‡</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td><strong>ç»è¥æ´»åŠ¨ç°é‡‘æµé‡å‡€é¢</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.operating.inflow|float) }}</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.operating.outflow|float) }}</strong></td>
                    </tr>
                    <tr class="table-success">
                        <td colspan="2"><strong>ç»è¥æ´»åŠ¨ç°é‡‘æµé‡å‡€é¢</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.operating.net|float) }}</strong></td>
                    </tr>
                    
                    <!-- æŠ•èµ„æ´»åŠ¨ -->
                    <tr class="table-primary">
                        <td colspan="3"><strong>äºŒã€æŠ•èµ„æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡</strong></td>
                    </tr>
                    {% for item in cashflow_statement.investing.item_list %}
                    <tr>
                        <td>{{ item.category_name }}</td>
                        {% if item.direction == "INFLOW" %}
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        <td style="text-align: right;">-</td>
                        {% else %}
                        <td style="text-align: right;">-</td>
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">æš‚æ— æŠ•èµ„æ´»åŠ¨ç°é‡‘æµé‡</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td><strong>æŠ•èµ„æ´»åŠ¨ç°é‡‘æµé‡å°è®¡</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.investing.inflow|float) }}</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.investing.outflow|float) }}</strong></td>
                    </tr>
                    <tr class="table-success">
                        <td colspan="2"><strong>æŠ•èµ„æ´»åŠ¨ç°é‡‘æµé‡å‡€é¢</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.investing.net|float) }}</strong></td>
                    </tr>
                    
                    <!-- ç­¹èµ„æ´»åŠ¨ -->
                    <tr class="table-primary">
                        <td colspan="3"><strong>ä¸‰ã€ç­¹èµ„æ´»åŠ¨äº§ç”Ÿçš„ç°é‡‘æµé‡</strong></td>
                    </tr>
                    {% for item in cashflow_statement.financing.item_list %}
                    <tr>
                        <td>{{ item.category_name }}</td>
                        {% if item.direction == "INFLOW" %}
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        <td style="text-align: right;">-</td>
                        {% else %}
                        <td style="text-align: right;">-</td>
                        <td style="text-align: right;">{{ "%.2f"|format(item.amount|float) }}</td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">æš‚æ— ç­¹èµ„æ´»åŠ¨ç°é‡‘æµé‡</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-info">
                        <td><strong>ç­¹èµ„æ´»åŠ¨ç°é‡‘æµé‡å°è®¡</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.financing.inflow|float) }}</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.financing.outflow|float) }}</strong></td>
                    </tr>
                    <tr class="table-success">
                        <td colspan="2"><strong>ç­¹èµ„æ´»åŠ¨ç°é‡‘æµé‡å‡€é¢</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.financing.net|float) }}</strong></td>
                    </tr>
                    
                    <!-- åˆè®¡ -->
                    <tr class="table-warning">
                        <td colspan="2"><strong>ç°é‡‘åŠç°é‡‘ç­‰ä»·ç‰©å‡€å¢åŠ é¢</strong></td>
                        <td style="text-align: right;"><strong>{{ "%.2f"|format(cashflow_statement.total_net|float) }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if not balance_sheet and not income_statement and not cashflow_statement %}
        <div class="alert alert-info" role="alert">
            <strong>æç¤ºï¼š</strong>æš‚æ— ä¼šè®¡æŠ¥è¡¨æ•°æ®ã€‚è¯·å…ˆå½•å…¥äº¤æ˜“æ•°æ®ã€‚
        </div>
    {% endif %}
{% endblock %}
