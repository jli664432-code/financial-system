# 交易记录流程说明

## 📝 记录一项交易后会发生什么

### 1. 用户提交交易数据
当您在"新增交易"页面填写并提交一笔交易时，系统会：

```
交易数据示例：
- 记账日期：2025-11-18
- 凭证号：JZ001
- 摘要：购买办公用品
- 分录1：现金科目 -500.00（贷方，负数表示）
- 分录2：办公费用科目 +500.00（借方，正数表示）
```

### 2. 系统验证借贷平衡
在保存之前，系统会检查：
- ✅ 至少需要2条分录（复式记账要求）
- ✅ 所有分录金额之和必须为 0（借贷平衡）

```python
# 验证逻辑（在 app/schemas/transaction.py 中）
total = sum(split.amount for split in self.splits)
if total != Decimal("0"):
    raise ValueError("借贷必须平衡（所有金额之和需为 0）")
```

### 3. 保存到数据库
如果验证通过，系统会：
1. 创建一条 `transactions` 记录（交易主表）
2. 创建多条 `splits` 记录（分录明细表）
3. 每条分录包含：
   - 关联的科目（account_guid）
   - 金额（value_num/value_denom，以分数形式存储）
   - 备注等信息

### 4. 更新科目余额
数据库视图 `v_account_balance` 会自动计算每个科目的余额：
- 借方金额（正数）增加科目余额
- 贷方金额（负数）减少科目余额

### 5. 影响会计报表
会计报表会从 `v_account_balance` 视图读取最新的科目余额，生成：
- **资产负债表**：资产、负债、所有者权益
- **利润表**：收入、费用、净利润

## ⚠️ 为什么会计报表显示"平衡未通过"？

### 问题原因

资产负债表的基本公式是：
```
资产 = 负债 + 所有者权益
```

但是，在实际会计中，这个公式应该包括：
```
资产 = 负债 + 所有者权益 + 净利润（未分配利润）
```

**当前问题：**
1. 收入/费用科目的余额会影响净利润
2. 净利润应该增加所有者权益（未分配利润）
3. 但当前的会计报表可能没有正确处理这个关系

### 具体场景

假设您记录了一笔交易：
- 收入：+1000元（主营业务收入）
- 费用：-500元（办公费用）
- 净利润：500元

在资产负债表中：
- 收入科目余额：+1000（但收入不应该在资产负债表中）
- 费用科目余额：-500（但费用不应该在资产负债表中）
- 这会导致资产 ≠ 负债 + 所有者权益

### 解决方案

需要调整会计报表逻辑：
1. **资产负债表**：只包含资产、负债、所有者权益科目，不包括收入/费用
2. **利润表**：包含收入、费用科目，计算净利润
3. **平衡检查**：资产 = 负债 + 所有者权益 + 净利润（未分配利润）

## 🔧 如何修复

我会修改会计报表的生成逻辑，确保：
1. 正确分类科目（收入/费用不在资产负债表中）
2. 将净利润纳入所有者权益
3. 正确计算平衡

